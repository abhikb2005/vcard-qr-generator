<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bulk vCard QR Code Generator from Excel/CSV</title>
    <meta name="description"
        content="Generate hundreds of vCard QR codes instantly from an Excel or CSV file. Secure, browser-based bulk generator for teams and businesses." />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Bulk vCard QR Code Generator",
        "url": "https://vcardqrcodegenerator.com/bulk-qr-code.html",
        "applicationCategory": "Utility",
        "operatingSystem": "All",
        "description": "Generate hundreds of vCard QR codes instantly from an Excel or CSV file. Secure, browser-based bulk generator for teams and businesses.",
        "offers": [
          {
            "@type": "Offer",
            "name": "Starter Batch",
            "price": "9",
            "priceCurrency": "USD"
          },
          {
            "@type": "Offer",
            "name": "Growth Batch",
            "price": "19",
            "priceCurrency": "USD"
          },
          {
            "@type": "Offer",
            "name": "Enterprise",
            "price": "29",
            "priceCurrency": "USD"
          }
        ],
        "author": {
          "@type": "Person",
          "name": "Abilash K B"
        }
      }
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1206702185649949"
        crossorigin="anonymous"></script>

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .step-active {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }

        .step-inactive {
            border-color: #e5e7eb;
            background-color: #f9fafb;
            opacity: 0.6;
        }

        .drag-active {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>

    <!-- Cookie Consent (must load before any tracking) -->
    <script src="/consent.js"></script>
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E90B41BNEH"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'G-E90B41BNEH');
    </script>
    <!-- 100% privacy-first analytics -->
    <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>

    <!-- PPP (Purchase Power Parity) Detection -->
    <script>
        (function () {
            // Country code -> discount percentage mapping based on PPP index
            const PPP_DISCOUNTS = {
                // 60% off - PPP index 0.2-0.3
                'AF': 60, 'BD': 60, 'BF': 60, 'BI': 60, 'CF': 60, 'TD': 60, 'KM': 60, 'CD': 60,
                'ER': 60, 'ET': 60, 'GM': 60, 'GN': 60, 'GW': 60, 'HT': 60, 'KP': 60, 'LR': 60,
                'MG': 60, 'MW': 60, 'ML': 60, 'MR': 60, 'MZ': 60, 'NP': 60, 'NE': 60, 'RW': 60,
                'SN': 60, 'SL': 60, 'SO': 60, 'SS': 60, 'SD': 60, 'SY': 60, 'TJ': 60, 'TZ': 60,
                'TG': 60, 'UG': 60, 'YE': 60, 'ZM': 60, 'ZW': 60, 'MM': 60, 'LA': 60, 'KH': 60,

                // 50% off - PPP index 0.3-0.5
                'DZ': 50, 'AO': 50, 'AM': 50, 'AZ': 50, 'BJ': 50, 'BT': 50, 'BO': 50, 'BW': 50,
                'CM': 50, 'CV': 50, 'CG': 50, 'CI': 50, 'DJ': 50, 'EG': 50, 'SV': 50, 'GQ': 50,
                'FJ': 50, 'GA': 50, 'GE': 50, 'GH': 50, 'GT': 50, 'GY': 50, 'HN': 50, 'IN': 50,
                'ID': 50, 'IQ': 50, 'JM': 50, 'JO': 50, 'KZ': 50, 'KE': 50, 'KG': 50, 'LB': 50,
                'LS': 50, 'LY': 50, 'MN': 50, 'MA': 50, 'NA': 50, 'NI': 50, 'NG': 50, 'PK': 50,
                'PY': 50, 'PH': 50, 'MD': 50, 'LK': 50, 'SR': 50, 'SZ': 50, 'TN': 50, 'TM': 50,
                'UA': 50, 'UZ': 50, 'VN': 50, 'PS': 50,

                // 40% off - PPP index 0.5-0.6
                'AL': 40, 'AR': 40, 'BY': 40, 'BA': 40, 'BR': 40, 'BG': 40, 'CL': 40, 'CN': 40,
                'CO': 40, 'CR': 40, 'HR': 40, 'DO': 40, 'EC': 40, 'MK': 40, 'HU': 40, 'IR': 40,
                'MY': 40, 'MU': 40, 'MX': 40, 'ME': 40, 'PA': 40, 'PE': 40, 'RO': 40, 'RU': 40,
                'RS': 40, 'ZA': 40, 'TH': 40, 'TR': 40, 'VE': 40,

                // 30% off - PPP index 0.6-0.7
                'BH': 30, 'CZ': 30, 'EE': 30, 'GR': 30, 'LV': 30, 'LT': 30, 'MT': 30, 'OM': 30,
                'PL': 30, 'PT': 30, 'QA': 30, 'SA': 30, 'SK': 30, 'SI': 30, 'TW': 30, 'AE': 30,
                'UY': 30, 'CY': 30, 'KW': 30,

                // 20% off - PPP index 0.7-0.8
                'BE': 20, 'FR': 20, 'DE': 20, 'HK': 20, 'IE': 20, 'IL': 20, 'IT': 20, 'JP': 20,
                'KR': 20, 'NL': 20, 'NZ': 20, 'SG': 20, 'ES': 20, 'SE': 20, 'AT': 20, 'FI': 20

                // No discount (0.8+): US, UK, AU, CA, CH, NO, DK, LU, IS
            };

            const COUNTRY_NAMES = {
                'IN': 'India', 'PK': 'Pakistan', 'BD': 'Bangladesh', 'NG': 'Nigeria', 'EG': 'Egypt',
                'VN': 'Vietnam', 'PH': 'Philippines', 'ID': 'Indonesia', 'BR': 'Brazil', 'MX': 'Mexico',
                'AR': 'Argentina', 'CO': 'Colombia', 'TH': 'Thailand', 'MY': 'Malaysia', 'ZA': 'South Africa',
                'TR': 'Turkey', 'PL': 'Poland', 'CZ': 'Czechia', 'RO': 'Romania', 'UA': 'Ukraine',
                'RU': 'Russia', 'CN': 'China', 'KR': 'South Korea', 'JP': 'Japan', 'IT': 'Italy',
                'ES': 'Spain', 'PT': 'Portugal', 'GR': 'Greece', 'HU': 'Hungary', 'CL': 'Chile',
                'PE': 'Peru', 'EC': 'Ecuador', 'KE': 'Kenya', 'GH': 'Ghana', 'MA': 'Morocco',
                'TN': 'Tunisia', 'LK': 'Sri Lanka', 'NP': 'Nepal', 'MM': 'Myanmar', 'KH': 'Cambodia',
                'LA': 'Laos', 'GE': 'Georgia', 'AM': 'Armenia', 'AZ': 'Azerbaijan', 'BY': 'Belarus',
                'MD': 'Moldova', 'RS': 'Serbia', 'BA': 'Bosnia', 'AL': 'Albania', 'MK': 'North Macedonia',
                'BG': 'Bulgaria', 'HR': 'Croatia', 'SI': 'Slovenia', 'SK': 'Slovakia', 'LT': 'Lithuania',
                'LV': 'Latvia', 'EE': 'Estonia', 'MT': 'Malta', 'CY': 'Cyprus', 'SA': 'Saudi Arabia',
                'AE': 'UAE', 'QA': 'Qatar', 'KW': 'Kuwait', 'BH': 'Bahrain', 'OM': 'Oman',
                'JO': 'Jordan', 'LB': 'Lebanon', 'IQ': 'Iraq', 'IR': 'Iran', 'AF': 'Afghanistan',
                'SY': 'Syria', 'YE': 'Yemen', 'ET': 'Ethiopia', 'TZ': 'Tanzania', 'UG': 'Uganda',
                'RW': 'Rwanda', 'ZM': 'Zambia', 'ZW': 'Zimbabwe', 'MW': 'Malawi', 'MZ': 'Mozambique',
                'SN': 'Senegal', 'CI': 'Ivory Coast', 'CM': 'Cameroon', 'GN': 'Guinea', 'ML': 'Mali',
                'BF': 'Burkina Faso', 'NE': 'Niger', 'TD': 'Chad', 'MG': 'Madagascar', 'MU': 'Mauritius',
                'NA': 'Namibia', 'BW': 'Botswana', 'SZ': 'Eswatini', 'LS': 'Lesotho', 'PA': 'Panama',
                'CR': 'Costa Rica', 'GT': 'Guatemala', 'HN': 'Honduras', 'SV': 'El Salvador', 'NI': 'Nicaragua',
                'BO': 'Bolivia', 'PY': 'Paraguay', 'UY': 'Uruguay', 'VE': 'Venezuela', 'DO': 'Dominican Republic',
                'JM': 'Jamaica', 'TT': 'Trinidad', 'GY': 'Guyana', 'SR': 'Suriname', 'HT': 'Haiti',
                'TW': 'Taiwan', 'HK': 'Hong Kong', 'SG': 'Singapore', 'MN': 'Mongolia', 'KZ': 'Kazakhstan',
                'UZ': 'Uzbekistan', 'TM': 'Turkmenistan', 'KG': 'Kyrgyzstan', 'TJ': 'Tajikistan',
                'BE': 'Belgium', 'NL': 'Netherlands', 'FR': 'France', 'DE': 'Germany', 'AT': 'Austria',
                'SE': 'Sweden', 'FI': 'Finland', 'IE': 'Ireland', 'IL': 'Israel', 'NZ': 'New Zealand'
            };

            const COUPON_CODES = {
                60: 'GLOBAL60',
                50: 'GLOBAL50',
                40: 'GLOBAL40',
                30: 'GLOBAL30',
                20: 'GLOBAL20'
            };

            async function detectAndShowPPP() {
                // Check if already dismissed this session
                if (sessionStorage.getItem('ppp_dismissed')) return;

                try {
                    const res = await fetch('https://ipapi.co/json/', { cache: 'default' });
                    const data = await res.json();
                    const countryCode = data.country_code;
                    const discount = PPP_DISCOUNTS[countryCode];

                    if (discount) {
                        const countryName = COUNTRY_NAMES[countryCode] || data.country_name || countryCode;
                        const coupon = COUPON_CODES[discount];
                        const banner = document.getElementById('ppp-banner');
                        const message = document.getElementById('ppp-message');

                        message.innerHTML = `üåç Hey! It looks like you're in <strong>${countryName}</strong>. Use code <strong class="bg-white/20 px-2 py-0.5 rounded font-mono">${coupon}</strong> for <strong>${discount}% off</strong> at checkout!`;
                        banner.classList.remove('hidden');

                        // Track PPP banner view
                        if (typeof gtag === 'function') {
                            gtag('event', 'ppp_banner_shown', {
                                event_category: 'ppp',
                                event_label: countryCode,
                                value: discount
                            });
                        }
                    }
                } catch (e) {
                    console.log('PPP detection skipped');
                }
            }

            // Run after page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', detectAndShowPPP);
            } else {
                detectAndShowPPP();
            }
        })();
    </script>
</head>

<body class="bg-gray-50 text-gray-900">

    <!-- PPP Discount Banner (hidden by default) -->
    <div id="ppp-banner"
        class="hidden bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 px-4 text-center text-sm">
        <span id="ppp-message"></span>
        <button
            onclick="sessionStorage.setItem('ppp_dismissed','1');document.getElementById('ppp-banner').classList.add('hidden')"
            class="ml-4 text-white/80 hover:text-white">‚úï</button>
    </div>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <a href="/" class="flex-shrink-0 flex items-center text-indigo-600 font-bold text-xl">
                        ‚Üê Back to Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Bulk vCard QR Code Generator</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">Upload your CSV file (exported from Excel) and generate
                strictly
                private, professional vCard QR codes for your entire team in seconds.</p>
        </div>

        <!-- Ad Unit: Top -->
        <div class="my-6 text-center min-h-[100px]">
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1206702185649949"
                data-ad-slot="7438060059" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Controls -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Step 1: Upload -->
                <div id="step1" class="bg-white rounded-xl shadow-sm border-2 border-indigo-600 p-6 transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span
                                class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">1</span>
                            Upload CSV File
                        </h2>
                        <a href="#" id="downloadSample" class="text-sm text-indigo-600 hover:underline">Download Sample
                            CSV</a>
                    </div>

                    <div id="dropZone"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-400 transition-colors">
                        <input type="file" id="csvInput" accept=".csv" class="hidden" />
                        <div class="space-y-2">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48">
                                <path d="M24 8l-8 8h6v16h4V16h6l-8-8z" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <div class="text-sm text-gray-600">
                                <span class="font-medium text-indigo-600 hover:text-indigo-500">Click to upload</span>
                                or drag and drop
                            </div>
                            <p class="text-xs text-gray-500">CSV files only (File > Save As > CSV in Excel)</p>
                        </div>
                    </div>
                    <p id="fileStats" class="mt-2 text-sm text-green-600 font-medium hidden"></p>
                </div>

                <!-- Step 2: Map Columns -->
                <div id="step2"
                    class="bg-white rounded-xl shadow-sm border-2 border-gray-200 p-6 opacity-50 pointer-events-none transition-all">
                    <h2 class="text-lg font-semibold flex items-center gap-2 mb-4">
                        <span
                            class="bg-gray-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">2</span>
                        Map Columns
                    </h2>
                    <p class="text-sm text-gray-500 mb-4">Match columns from your CSV to vCard fields.</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="mappingGrid">
                        <!-- Mappings injected here -->
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button id="generateBtn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-md font-semibold transition shadow-lg shadow-indigo-200">
                            Generate Preview
                        </button>
                    </div>
                </div>

            </div>

            <!-- Right Column: Preview & Action -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Preview Box -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 sticky top-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Preview (First Entry)</h3>

                    <div id="previewContainer"
                        class="flex flex-col items-center justify-center min-h-[200px] bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-gray-400 text-sm">Upload data to see preview</p>
                    </div>

                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Total Contacts:</span>
                            <span class="font-medium" id="totalCount">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Est. File Size:</span>
                            <span class="font-medium" id="estSize">-</span>
                        </div>
                    </div>

                    <div class="mt-6 border-t pt-6" id="actionArea">
                        <div id="paywall" class="hidden">
                            <p class="text-sm text-center text-gray-600 mb-4">Select a plan to download your <span
                                    id="countDisplay" class="font-bold">0</span> QR codes:</p>

                            <div class="space-y-3">
                                <!-- Tier 1: 0-50 -->
                                <div class="border rounded-lg p-3 hover:border-indigo-500 cursor-pointer transition flex justify-between items-center"
                                    id="tier1-card">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">Starter Batch</h4>
                                        <p class="text-xs text-gray-500">Up to 50 codes</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="block font-bold text-gray-900">$9</span>
                                        <button onclick="initiateCheckout('pdt_0NXPxlipsCiIWgeLUcl6M')"
                                            class="text-xs bg-indigo-600 text-white px-2 py-1 rounded mt-1">Buy</button>
                                    </div>
                                </div>

                                <!-- Tier 2: 51-500 -->
                                <div class="border rounded-lg p-3 hover:border-indigo-500 cursor-pointer transition flex justify-between items-center"
                                    id="tier2-card">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">Growth Batch</h4>
                                        <p class="text-xs text-gray-500">Up to 500 codes</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="block font-bold text-gray-900">$19</span>
                                        <button onclick="initiateCheckout('pdt_0NXPxyJkVPTIFnQ2bS5xM')"
                                            class="text-xs bg-indigo-600 text-white px-2 py-1 rounded mt-1">Buy</button>
                                    </div>
                                </div>

                                <!-- Tier 3: Unlimited -->
                                <div class="border rounded-lg p-3 hover:border-indigo-500 cursor-pointer transition flex justify-between items-center"
                                    id="tier3-card">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">Enterprise</h4>
                                        <p class="text-xs text-gray-500">Unlimited codes</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="block font-bold text-gray-900">$29</span>
                                        <button onclick="initiateCheckout('pdt_0NXPy4nZegDt6mQKDzlkX')"
                                            class="text-xs bg-indigo-600 text-white px-2 py-1 rounded mt-1">Buy</button>
                                    </div>
                                </div>
                            </div>

                            <p class="text-xs text-gray-400 mt-4 text-center">Secure payment via Dodo Payments</p>
                        </div>

                        <div id="downloadArea" class="hidden">
                            <div class="bg-green-50 text-green-800 p-3 rounded-lg mb-4 text-sm text-center">
                                Payment Verified! <br>
                                <span class="text-xs text-green-600" id="limitMsg"></span>
                            </div>
                            <button id="downloadZipBtn"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2">
                                <span>Download .ZIP</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Trust Signals -->
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
                    <h4 class="font-semibold text-blue-900 text-sm mb-2">üîí Privacy First</h4>
                    <p class="text-xs text-blue-800">Processing happens entirely in your browser. Your employee data is
                        never uploaded to our servers.</p>
                </div>

            </div>
        </div>

        <!-- Ad Unit: Bottom -->
        <div class="mt-12 text-center min-h-[100px]">
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1206702185649949"
                data-ad-slot="4811896719" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

    </div>

    <script>
        // Configuration
        const WORKER_URL = "https://dodo-create-checkout.abhikb2005.workers.dev/";
        const VALIDATOR_URL = "https://token-validator.abhikb2005.workers.dev/";

        // Products
        const PRODUCTS = {
            'pdt_0NXPxlipsCiIWgeLUcl6M': { limit: 50 },
            'pdt_0NXPxyJkVPTIFnQ2bS5xM': { limit: 500 },
            'pdt_0NXPy4nZegDt6mQKDzlkX': { limit: Infinity }
        };

        let parsedData = [];
        let headers = [];
        let isPaid = false;
        let purchasedLimit = 0;

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const csvInput = document.getElementById('csvInput');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const fileStats = document.getElementById('fileStats');
        const mappingGrid = document.getElementById('mappingGrid');
        const previewContainer = document.getElementById('previewContainer');
        const totalCountEl = document.getElementById('totalCount');
        const estSizeEl = document.getElementById('estSize');
        const generateBtn = document.getElementById('generateBtn');
        const paywall = document.getElementById('paywall');
        const countDisplay = document.getElementById('countDisplay');
        const downloadArea = document.getElementById('downloadArea');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const limitMsg = document.getElementById('limitMsg');
        const downloadSample = document.getElementById('downloadSample');

        // Sample CSV Download
        downloadSample.addEventListener('click', (e) => {
            e.preventDefault();
            const csvContent = "data:text/csv;charset=utf-8,Full Name,Phone,Email,Company,Job Title,Website\nJohn Doe,+15550001,john@example.com,Acme Inc,Manager,https://acme.com";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "vcard_sample.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Check Payment Status (Token in URL)
        async function checkPayment() {
            const url = new URL(window.location.href);
            const token = url.searchParams.get('token');

            if (token) {
                try {
                    const res = await fetch(`${VALIDATOR_URL}?token=${encodeURIComponent(token)}`);
                    const json = await res.json();
                    if (json.status === 'success') {
                        // START NEW LOGIC: Using product_id from validation response
                        // Fallback for now until backend is updated: we set highest limit if success
                        // In future, json should return { status: 'success', product_id: '...' }

                        const pid = json.product_id;
                        if (pid && PRODUCTS[pid]) {
                            purchasedLimit = PRODUCTS[pid].limit;
                            isPaid = true;
                        } else {
                            // Fallback if backend doesn't send product_id yet: assume Unlimited for safety/UX
                            purchasedLimit = Infinity;
                            isPaid = true;
                        }

                        // Persist session
                        localStorage.setItem('bulk_session', JSON.stringify({
                            expires: Date.now() + 1000 * 60 * 60,
                            limit: purchasedLimit
                        }));

                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { console.error(e); }
            }

            // Check local storage
            const session = JSON.parse(localStorage.getItem('bulk_session') || '{}');
            if (session && session.expires && session.expires > Date.now()) {
                isPaid = true;
                purchasedLimit = session.limit;
            }

            updateActionArea();
        }

        function updateActionArea() {
            if (!parsedData.length) return;
            countDisplay.textContent = parsedData.length;

            const count = parsedData.length;

            // Auto-highlight best plan
            document.getElementById('tier1-card').classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
            document.getElementById('tier2-card').classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
            document.getElementById('tier3-card').classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');

            if (count <= 50) {
                document.getElementById('tier1-card').classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
            } else if (count <= 500) {
                document.getElementById('tier2-card').classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
            } else {
                document.getElementById('tier3-card').classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
            }

            if (isPaid && purchasedLimit >= count) {
                paywall.classList.add('hidden');
                downloadArea.classList.remove('hidden');
                limitMsg.textContent = `Limit: ${purchasedLimit === Infinity ? 'Unlimited' : purchasedLimit} codes`;
            } else {
                paywall.classList.remove('hidden');
                downloadArea.classList.add('hidden');
            }
        }

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
        });
        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => csvInput.click());
        csvInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleDrop(e) {
            const dt = e.dataTransfer;
            handleFiles(dt.files);
        }

        function handleFiles(files) {
            const file = files[0];
            if (file && file.type === "text/csv" || file.name.endsWith('.csv')) {
                parseCSV(file);
                fileStats.textContent = `Loaded: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileStats.classList.remove('hidden');
            } else {
                alert("Please upload a valid CSV file.");
            }
        }

        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    parsedData = results.data;
                    headers = results.meta.fields;
                    if (parsedData.length > 0) {
                        enableStep2();
                        totalCountEl.textContent = parsedData.length;
                        estSizeEl.textContent = `~${(parsedData.length * 0.05).toFixed(1)} MB`; // rough est
                    } else {
                        alert("CSV appears empty.");
                    }
                }
            });
        }

        function enableStep2() {
            step2.classList.remove('opacity-50', 'pointer-events-none');
            step2.classList.add('border-indigo-600');
            step1.classList.remove('border-indigo-600');
            step1.classList.add('border-gray-200');

            // Generate Selects
            const vCardFields = [
                { key: 'fn', label: 'Full Name' },
                { key: 'tel', label: 'Phone Number' },
                { key: 'email', label: 'Email' },
                { key: 'org', label: 'Company' },
                { key: 'title', label: 'Job Title' },
                { key: 'url', label: 'Website' }
            ];

            mappingGrid.innerHTML = '';
            vCardFields.forEach(field => {
                const div = document.createElement('div');
                div.className = "flex flex-col";

                let options = `<option value="">-- Ignore --</option>`;
                headers.forEach(h => {
                    // Auto-match logic
                    const selected = h.toLowerCase().includes(field.key) || h.toLowerCase().includes(field.label.toLowerCase().split(' ')[0]) ? 'selected' : '';
                    options += `<option value="${h}" ${selected}>${h}</option>`;
                });

                div.innerHTML = `
          <label class="text-xs font-semibold uppercase text-gray-500 mb-1">${field.label}</label>
          <select id="map-${field.key}" class="border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
            ${options}
          </select>
        `;
                mappingGrid.appendChild(div);
            });
        }

        // Logic to build vCard string from a row and mapping
        function buildVCard(row) {
            const getVal = (key) => {
                const header = document.getElementById(`map-${key}`).value;
                return header ? (row[header] || '').trim() : '';
            };

            const fn = getVal('fn');
            if (!fn) return null; // Name is required

            const tel = getVal('tel');
            const email = getVal('email');
            const org = getVal('org');
            const title = getVal('title');
            const url = getVal('url');

            const parts = fn.split(' ');
            const firstName = parts.shift() || '';
            const lastName = parts.join(' ') || '';

            return `BEGIN:VCARD
VERSION:3.0
N:${lastName};${firstName};;;
FN:${fn}
ORG:${org}
TITLE:${title}
TEL;TYPE=WORK,VOICE:${tel}
EMAIL:${email}
URL:${url}
END:VCARD`;
        }

        generateBtn.addEventListener('click', async () => {
            // Show loading in preview
            previewContainer.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>`;

            // 1. Generate first QR for Preview
            const firstRow = parsedData[0];
            const vCardData = buildVCard(firstRow);

            if (!vCardData) {
                alert("Could not generate vCard. Ensure 'Full Name' is mapped correctly.");
                return;
            }

            const qr = new QRCodeStyling({
                width: 200, height: 200, type: 'svg', data: vCardData,
                imageOptions: { crossOrigin: 'anonymous', margin: 5 },
                dotsOptions: { color: '#000000', type: 'rounded' }
            });

            previewContainer.innerHTML = '';
            qr.append(previewContainer);

            updateActionArea();
        });

        // Global Checkout Function
        window.initiateCheckout = async (productId) => {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "...";

            try {
                const email = (parsedData[0] && (parsedData[0]['Email'] || parsedData[0]['email'])) || "customer@example.com";
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, product_id: productId }) // Send specific product ID
                });
                const data = await res.json();
                if (data.checkout_url) window.location.href = data.checkout_url;
                else throw new Error("No URL");
            } catch (e) {
                alert("Payment error. Please try again.");
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        downloadZipBtn.addEventListener('click', async () => {
            downloadZipBtn.disabled = true;
            downloadZipBtn.textContent = "Generating ZIP...";

            const zip = new JSZip();
            let count = 0;

            if (parsedData.length > purchasedLimit) {
                alert(`Note: Your plan has a limit of ${purchasedLimit} codes. Only the first ${purchasedLimit} will be generated.`);
            }

            for (const row of parsedData) {
                if (count >= purchasedLimit) break;

                const vCardData = buildVCard(row);
                if (vCardData) {
                    const qr = new QRCodeStyling({
                        width: 512, height: 512, type: 'canvas', data: vCardData, // High res for download
                        dotsOptions: { color: '#000000', type: 'rounded' }
                    });

                    // We need to wait for the blob
                    const blob = await qr.getRawData('png');
                    if (blob) {
                        const name = row[document.getElementById('map-fn').value] || `contact_${count}`;
                        const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        zip.file(`${safeName}.png`, blob);
                        count++;
                    }
                }
            }

            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, "bulk_vcard_qrcodes.zip");

            downloadZipBtn.textContent = "Download .ZIP";
            downloadZipBtn.disabled = false;
        });

        // Init
        checkPayment();

    </script>
</body>

</html>